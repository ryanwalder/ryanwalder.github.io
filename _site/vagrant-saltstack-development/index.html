<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Using Vagrant for SaltStack States Development &middot; Ryan Walder
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
                                 <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body class="layout">

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          Ryan Walder
        </a>
      </h1>
      <p class="lead">The rambling of a Linux admin with DevOps tendencies.</p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="/">Home</a>

      

      
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/about.html">About</a>
          
        
      
        
          
            <a class="sidebar-nav-item" href="/archive.html">Archive</a>
          
        
      
        
      
        
          
        
      

      <a class="sidebar-nav-item" href="https://github.com/ryanwalder">GitHub</a>
    </nav>

    <p>&copy; 2015</p>
  </div>
</div>


    <div class="content container">
      <div class="post">
  <h1 class="post-title">Using Vagrant for SaltStack States Development</h1>
  <span class="post-date">21 Apr 2015</span>
  <p>I won’t get too deep on the subject of why Vagrant is a great tool for development, Darren Beale has a great <a href="http://24ways.org/2014/what-is-vagrant-and-why-should-i-care/">writeup</a> on the subject, while it’s more development based it still holds true for developing your Salt states. The TL;DR is that <a href="https://www.vagrantup.com">Vagrant</a> gives us the ability to spin up machines then tear them down as needed, this is great for writing config management states as you can plug on through getting a system configured, tear the machine down then reprovision it from scratch.</p>

<h2 id="vagrant-and-lxc">Vagrant and lxc</h2>

<p>I use a slightly modified version of Vagrant in that I use LXC containers for my development machines rather than VirtualBox machines, this gives me a faster startup time for my machines and they use a lot less system resources while still giving me a full system to work on.</p>

<h2 id="installing-vagrant--plugins">Installing Vagrant &amp; Plugins</h2>
<p>I use Ubuntu 14.04 as my day to day work machine so these commands targeted to it, if you use another distro or run a later version things may differ slightly, we need a newer version of Vagrant than is in the standard Ubuntu repo’s so we’ll be grabbing it directly from the <a href="https://www.vagrantup.com/downloads.html">site</a>:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>wget https://dl.bintray.com/mitchellh/vagrant/vagrant_1.7.2_x86_64.deb
sudo dpkg -i vagrant_1.7.2_x86_64.deb
</code></pre>
</div>

<p>Now we have vagrant installed we need a few extra packages to get LXC working as our provider:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>sudo apt-get update
sudo apt-get install sudo apt-get install lxc lxc-templates redir cgroup-lite git-core
</code></pre>
</div>

<p>Now to install a couple of Vagrant plugins to allow us to get going:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>vagrant plugin install vagrant-lxc
vagrant plugin install salty-vagrant-grains
vagrant plugin install vagrant-cachier
</code></pre>
</div>

<p>vagrant-cachier is not required but it can <a href="http://fgrehm.viewdocs.io/vagrant-cachier/benchmarks">speed up</a> the time it takes to spin up boxes by caching commonly used packages, I use it on a per machine basis in this setup which beans caches will survive across destroying a named machine (say “saltmaster”) which means destroying and spinning up machines gets a bit faster.</p>

<h2 id="setting-up-vagrant">Setting up Vagrant</h2>
<p>We need to grab the repo with the Vagrantfile in, this contains everything we need to develop salt states in Vagrant including a Salt Master and the ability to define minions within a YAML file which makes defining new machines a breeze</p>

<div class="highlighter-rouge"><pre class="highlight"><code>git clone https://github.com/ryanwalder/saltstack-lxc-vagrant
cd saltstack-lxc-vagrant
</code></pre>
</div>

<p>For the purpose of this post we’ll be using the example states/pillars provided in the example folder of the repo, this will setup 4 nginx boxes behind a hapoxy box.</p>

<p>We need to set a few environmental variables which point to our salt states and salt pillar directories, these folders will be mounted into the container at /srv/salt and /srv/pillar which are then in turn used by the Salt Master.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>export VLS_STATES="example/states"
export VLS_PILLAR="example/pillar"
</code></pre>
</div>

<p>Now we just need to copy the example minions.yaml into place and we can get going:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>cp minions.yaml.example minions.yaml
</code></pre>
</div>

<p>First we will fire up the Salt Master, as we are using LXC as our provider we need to specify this:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>vagrant up saltmaster --provider=lxc
</code></pre>
</div>

<p>If like me you like minimising keystrokes we can set Vagrant to use LXC by default with:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>export VAGRANT_DEFAULT_PROVIDER=lxc
</code></pre>
</div>

<p>After a few minutes you’ll have a fully working Salt Master ready to provision systems you can check this out by jumping onto the machine, one on you can check out the shares states &amp; pillar folders.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>vagrant ssh saltmaster
ls /srv/salt
ls /srv/pillar
</code></pre>
</div>

<p>As you can see the folders in <code class="highlighter-rouge">example/states</code> and <code class="highlighter-rouge">example/pillar</code> are shared from the host which means we can edit files on our local machine from the comfort of your own environment and have them immediately available on the Salt Master ready to deploy.</p>

<h2 id="firing-up-the-minions">Firing up the minions</h2>

<p>Check the status of out vagrant setup you can use <code class="highlighter-rouge">vagrant status</code> which will give something like the below:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Current machine states:

saltmaster                running (lxc)
nginx-001                 not created (lxc)
nginx-002                 not created (lxc)
nginx-003                 not created (lxc)
nginx-004                 not created (lxc)
haproxy                   not created (lxc)

This environment represents multiple VMs. The VMs are all listed
above with their current state. For more information about a specific
VM, run `vagrant status NAME`.
</code></pre>
</div>

<p>The saltmaster is already running which means rather than spinning up each box individually we can just bring them all up at once with <code class="highlighter-rouge">vagrant up</code> rather than <code class="highlighter-rouge">vagrant up nginx-001</code>, this only works once the saltmaster box is up otherwise you’ll have a race condition between the minions and the master where if they come up before the master things can get out of step which need the minions restarting, which is no fun.</p>

<p>As you can see from the <code class="highlighter-rouge">minions.yaml</code> config file the nginx boxes will run a highstate on being provisioned but the haproxy boxes does not so you’ll need to jump on the box and run a highstate manually.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>vagrant ssh haproxy
sudo salt-call state.highstate
</code></pre>
</div>

<p>You should see Salt install and configure haproxy so now you can go to <code class="highlighter-rouge">10.0.3.15</code> where you should be able to refresh the page and see haproxy rotate through the first 3 nginx boxes we previously setup, you can also see that the 3 nodes are talking to haproxy by going to <code class="highlighter-rouge">10.0.3.15:1936</code>.</p>

<h2 id="working-on-salt-states">Working on salt states</h2>

<p>Now we need to update haproxy to use the 4th nginx node, while we could add the 4th node to the haproxy config manually but the better way would be to use <a href="http://docs.saltstack.com/en/latest/topics/mine/">Salt Mine</a>, as you can see in <code class="highlighter-rouge">example/pillar/nginx/init.sls</code> we are already exporting the eth1 IP address of the nginx nodes via the salt mine so we can use this in the haproxy config. I’ve included a jinja templated config which does this so you just need to edit the <code class="highlighter-rouge">example/states/haproxy/init.sls</code> state file in the git repo to include “.jinja” to the end of the file.managed source line:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="s">haproxy</span><span class="pi">:</span>
  <span class="s">pkg</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">latest</span>
  <span class="s">file</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">managed</span>
    <span class="pi">-</span> <span class="s">name</span><span class="pi">:</span> <span class="s">/etc/haproxy/haproxy.cfg</span>
    <span class="pi">-</span> <span class="s">source</span><span class="pi">:</span> <span class="s">salt://haproxy/files/haproxy.cfg.jinja</span>
    <span class="pi">-</span> <span class="s">template</span><span class="pi">:</span> <span class="s">jinja</span>
    <span class="pi">-</span> <span class="s">user</span><span class="pi">:</span> <span class="s">root</span>
    <span class="pi">-</span> <span class="s">group</span><span class="pi">:</span> <span class="s">root</span>
    <span class="pi">-</span> <span class="s">mode</span><span class="pi">:</span> <span class="s">644</span>
    <span class="pi">-</span> <span class="s">require</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">pkg</span><span class="pi">:</span> <span class="s">haproxy</span>
    <span class="pi">-</span> <span class="s">watch_in</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">service</span><span class="pi">:</span> <span class="s">haproxy</span>
  <span class="s">service</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">running</span>
    <span class="pi">-</span> <span class="s">enable</span><span class="pi">:</span> <span class="s">True</span>
    <span class="pi">-</span> <span class="s">require</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">file</span><span class="pi">:</span> <span class="s">enable-haproxy-service</span>
</code></pre>
</div>

<p>This will now use the templated file for setting up the haproxy config so we just need to run a highstate on the haproxy box again:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>vagrant ssh haproxy
sudo salt-call state.highstate
</code></pre>
</div>

<p>Once Salt has done it’s thing you can now check it has been added to the haproxy config by checking out the web frontend at <code class="highlighter-rouge">10.0.3.15:1936</code> again and you should now see all 4 minions being load balanced, no editing files remotely, no having to pull anything onto the master just a really quick edit to your states and they are available to deploy to the minions immediately, this gives us that quick feedback loop we need when building our states with the ability to start from scratch whenever we need with only a few commands.</p>

<p>Now we have the states in their “final” setup it’s good to get in the habit of destroying the minions and re-provisioning them from scratch to make sure the states work from on fresh systems, this doesn’t affect the examples as much as full state development where you’ll be running states multiple times before nailing things down which can lead to states which only work after multiple runs due to the ordering of the states.</p>

<h2 id="notes">Notes</h2>

<p>Vagrant keeps track of the containers it’s using based on the config you’re using so if you remove a box from the minions.yaml that is still running vagrant will not keep track of it any more so it’s best practice to make liberal use of <code class="highlighter-rouge">vagrant status</code> as you go along to keep track of what’s running and make sure to <code class="highlighter-rouge">vagrant destroy</code> boxes before taking them out of the <code class="highlighter-rouge">minions.yaml</code>. You can always check what containers you have running at any given time by using <code class="highlighter-rouge">sudo lxc-ls</code> and if you need to kill off errant containers you forgot to destroy before removing them from the YAMl file you can destroy them directly with lxc directly:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>sudo lxc-stop --name container-name
sudo lxc-destroy --name container-name
</code></pre>
</div>

<p>And if you just want to nuke everything from orbit:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>for i in $(sudo lxc-ls); do sudo lxc-stop --name $i; sudo lxc-destroy --name $i; done
</code></pre>
</div>

</div>

      
<!-- Add Disqus comments. -->
<div id="disqus_thread"></div>
<script type="text/javascript">
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'ryanwalder'; // required: replace example with your forum shortname
  var disqus_identifier = "/vagrant-saltstack-development";

  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


    </div>

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-59465484-2', 'auto');
  ga('send', 'pageview');

</script>

  </body>
</html>
